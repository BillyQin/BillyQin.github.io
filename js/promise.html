<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>手写Promise A+, 已通过官方872个测试用例 | BillyQin&#39;s Blog</title>
    <meta name="description" content="覃昶栋的博客">
    
    
    <link rel="preload" href="/assets/css/0.styles.78f28ec0.css" as="style"><link rel="preload" href="/assets/js/app.9730f399.js" as="script"><link rel="preload" href="/assets/js/2.213b8df9.js" as="script"><link rel="preload" href="/assets/js/5.99232bff.js" as="script"><link rel="prefetch" href="/assets/js/10.60df9075.js"><link rel="prefetch" href="/assets/js/11.a4f2fcc4.js"><link rel="prefetch" href="/assets/js/12.44d90055.js"><link rel="prefetch" href="/assets/js/13.ceae2632.js"><link rel="prefetch" href="/assets/js/14.304a1956.js"><link rel="prefetch" href="/assets/js/15.1f9d2056.js"><link rel="prefetch" href="/assets/js/16.dba58892.js"><link rel="prefetch" href="/assets/js/17.6a7846cc.js"><link rel="prefetch" href="/assets/js/18.d71ca2de.js"><link rel="prefetch" href="/assets/js/19.e3465d82.js"><link rel="prefetch" href="/assets/js/20.4a6db421.js"><link rel="prefetch" href="/assets/js/21.e0056130.js"><link rel="prefetch" href="/assets/js/22.79515555.js"><link rel="prefetch" href="/assets/js/23.fd1d672d.js"><link rel="prefetch" href="/assets/js/24.622e0bcd.js"><link rel="prefetch" href="/assets/js/25.2b6c2c15.js"><link rel="prefetch" href="/assets/js/26.6bbd0a9c.js"><link rel="prefetch" href="/assets/js/3.83f42462.js"><link rel="prefetch" href="/assets/js/4.c5ced64c.js"><link rel="prefetch" href="/assets/js/6.ea9383a2.js"><link rel="prefetch" href="/assets/js/7.e84773c7.js"><link rel="prefetch" href="/assets/js/8.11ca5427.js"><link rel="prefetch" href="/assets/js/9.e9209c05.js">
    <link rel="stylesheet" href="/assets/css/0.styles.78f28ec0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">BillyQin's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://github.com/BillyQin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="https://github.com/BillyQin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/js/hoisting.html" class="sidebar-link">变量提升</a></li><li><a href="/js/this.html" class="sidebar-link">this是什么？</a></li><li><a href="/js/transformation.html" class="sidebar-link">数据类型转换的4大核心规则</a></li><li><a href="/js/promise.html" class="active sidebar-link">手写Promise A+, 已通过官方872个测试用例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/promise.html#promise-a-规范" class="sidebar-link">Promise A+ 规范</a></li><li class="sidebar-sub-header"><a href="/js/promise.html#es5-实现-promise-源码过程（三部曲）" class="sidebar-link">ES5 实现 Promise 源码过程（三部曲）</a></li><li class="sidebar-sub-header"><a href="/js/promise.html#promise测试" class="sidebar-link">Promise测试</a></li><li class="sidebar-sub-header"><a href="/js/promise.html#promise-源码完整版" class="sidebar-link">Promise 源码完整版</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="手写promise-a-已通过官方872个测试用例"><a href="#手写promise-a-已通过官方872个测试用例" class="header-anchor">#</a> 手写Promise A+, 已通过官方872个测试用例</h1> <p>Promise 是 ES6 中得一个内置类。Promise 在有效规划异步编程代码，尤其是处理 ajax 异步请求的回调地狱上都有很大的帮助。</p> <p>在 JS 中，Promise 和 async/await 作为主流的异步处理方式，我们有必要了解实现原理。</p> <h2 id="promise-a-规范"><a href="#promise-a-规范" class="header-anchor">#</a> Promise A+ 规范</h2> <p>Promise 最早由社区提出和实现，ES6 将其写进了语言标准，统一了用法，原生提供了 Promise 对象。
目前 Promise A+ 规范为主流，也是我们学习的目标。详细内容可以看官方文档 https://promisesaplus.com/</p> <p>规范内容较长，总结为以下几点：</p> <h4 id="_1-promise-状态-promisea-2-1"><a href="#_1-promise-状态-promisea-2-1" class="header-anchor">#</a> 1. Promise 状态(<a href="https://promisesaplus.com/#promise-states" target="_blank" rel="noopener noreferrer">PromiseA+ 2.1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</h4> <p>Promise 有三种状态，分别是 pending（等待）、fulfilled（执行）、rejected（拒绝）</p> <p>Promise 的初始状态为 pending，一旦被修改为 fulfilled 或者 rejected 后，状态不能再改变</p> <h4 id="_2-then-函数-promisea-2-2"><a href="#_2-then-函数-promisea-2-2" class="header-anchor">#</a> 2. then 函数(<a href="https://promisesaplus.com/#the-then-method" target="_blank" rel="noopener noreferrer">PromiseA+ 2.2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</h4> <p>then 函数接受两个函数作为可选参数</p> <div class="language-js extra-class"><pre class="language-js"><code>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>then 函数遵循以下几个规则：</p> <ul><li>参数不为函数时应该被忽略</li> <li>两个参数函数都应该异步执行，即放入事件队列，而非同步立即执行</li> <li>调用 onFulfilled 函数时，会将当前 Promise 的值作为参数传入</li> <li>调用 onRejected 函数时，会将当前 Promise 的失败原因作为参数传入</li> <li>then 函数的返回值为 Promise</li></ul> <h4 id="_3-promise-解决过程-promisea-2-3"><a href="#_3-promise-解决过程-promisea-2-3" class="header-anchor">#</a> 3. Promise 解决过程(<a href="https://promisesaplus.com/#the-promise-resolution-procedure" target="_blank" rel="noopener noreferrer">PromiseA+ 2.3<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</h4> <p>Promise 解决过程是一个抽象的操作，接收一个 promise 和一个值 x，目的是对 Promise 形式的执行结果进行统一处理。按照规范文档，有以下三种情况</p> <ul><li>promise 等于 x。此时抛出 TypeError 错误，拒绝 promise</li> <li>x 是 Promise 的一个实例。此时如果 x 为 pending（等待）状态，则 promise 继续等待直至 x 变为 fulfilled（执行）或者 rejected（拒绝），否则根据 x 的状态来 fulfilled（执行）/rejected（拒绝）promise</li> <li>x 为对象或者函数 这一步是处理拥有 then()函数的对象或者函数（这类对象或者函数不是 Promise 实例，只是拥有 then 函数）。处理方式是调用 then()方法，调用时将 this 指向 x,将 then 回调函数的结果 y 传入新的 Promise 解决过程，如果执行期间报错，则以对应的错误为原因拒绝 promise</li></ul> <h2 id="es5-实现-promise-源码过程（三部曲）"><a href="#es5-实现-promise-源码过程（三部曲）" class="header-anchor">#</a> ES5 实现 Promise 源码过程（三部曲）</h2> <h3 id="_1-初始化"><a href="#_1-初始化" class="header-anchor">#</a> 1. 初始化</h3> <ul><li>确定promise三种状态</li> <li>promise的构造函数需要传一个函数作为参数。该函数具备resolve、reject两个参数</li> <li>执行resolve/reject时修改状态、值、执行回调函数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// promise三种状态</span>
<span class="token keyword">var</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
<span class="token comment">// 构造函数</span>
<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始状态为peding,初始值为空</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledFn <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放成功的回调函数</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedFn <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放失败的回调函数</span>
  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// setTimeout构成异步</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 一旦被修改为 fulfilled 或者 rejected 后，状态不能再改变</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _this<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>onFulfilledFn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// setTimeout构成异步</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 一旦被修改为 fulfilled 或者 rejected 后，状态不能再改变</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _this<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>onRejectedFn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行参数</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 报错则返回reject</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 原型方法</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  constructor<span class="token operator">:</span> MyPromise<span class="token punctuation">,</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">catch</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">finally</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 静态方法</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">allSetted</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-加入then函数"><a href="#_2-加入then函数" class="header-anchor">#</a> 2. 加入then函数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  constructor<span class="token operator">:</span> MyPromise<span class="token punctuation">,</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// PromiseA+ 2.2.1 参数不是函数，直接忽略</span>
      <span class="token function-variable function">onFulfilled</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 链式调用。返回promise</span>
        <span class="token keyword">return</span> MyPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onRejected <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// PromiseA+ 2.2.1 参数不是函数，直接忽略</span>
      <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 链式调用。返回promise</span>
        <span class="token keyword">return</span> MyPromise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// PromiseA+ 2.2.7 返回promise供链式调用。</span>
    <span class="token keyword">var</span> promise<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">FULFILLED</span><span class="token operator">:</span>
        promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 用try/catch包一层 执行传入的回调函数，报错则reject</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">REJECTED</span><span class="token operator">:</span>
        promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">PENDING</span><span class="token operator">:</span>
        promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// pending时，将回调函数存放onFulfilledFn，等待状态改变后执行。</span>
          _this<span class="token punctuation">.</span>onFulfilledFn<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          _this<span class="token punctuation">.</span>onRejectedFn<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">catch</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// catch的本质就是then方法只传第二个参数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-promise-解决过程-resolvepromise"><a href="#_3-promise-解决过程-resolvepromise" class="header-anchor">#</a> 3. Promise 解决过程 - resolvePromise()</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'x 不能和 promise相等'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// x是promise实例</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// pending状态，继续等待</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// x不是promise实例，是object/function</span>
    <span class="token keyword">var</span> executed<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
      <span class="token comment">// 具备then方法</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用then,this指向x</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          x<span class="token punctuation">,</span>
          <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// 回调函数的结果 y 传入新的 Promise 解决过程</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不具备then方法 直接resolve</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行过程中报错 直接reject</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 非object和function，直接resolve</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="promise测试"><a href="#promise测试" class="header-anchor">#</a> Promise测试</h2> <p>为了验证手写Promise的正确性，这里引用官方promise测试库来测试。
官方测试库： https://github.com/promises-aplus/promises-tests
项目里直接install</p> <div class="language-js extra-class"><pre class="language-js"><code>npm install promises<span class="token operator">-</span>aplus<span class="token operator">-</span>tests
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 调用官方测试用例，需实现一个promise的延迟对象 defer</span>
MyPromise<span class="token punctuation">.</span>defer <span class="token operator">=</span> MyPromise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dfd <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  dfd<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dfd<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
    dfd<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">promisesAplusTests</span><span class="token punctuation">(</span>MyPromise<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt="An image">
872个测试用例全部通过～</p> <h2 id="promise-源码完整版"><a href="#promise-源码完整版" class="header-anchor">#</a> Promise 源码完整版</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 调用官方测试库 保证手写代码的正确性</span>
<span class="token keyword">const</span> promisesAplusTests <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'promises-aplus-tests'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// https://promisesaplus.com/#point-5</span>
<span class="token keyword">var</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'x 不能和 promise相等'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> executed<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          x<span class="token punctuation">,</span>
          <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 构造函数</span>
<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledFn <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedFn <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _this<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>onFulfilledFn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _this<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        _this<span class="token punctuation">.</span>onRejectedFn<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
  constructor<span class="token operator">:</span> MyPromise<span class="token punctuation">,</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onFulfilled</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> MyPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onRejected <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> MyPromise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> promise<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">FULFILLED</span><span class="token operator">:</span>
        promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">REJECTED</span><span class="token operator">:</span>
        promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">PENDING</span><span class="token operator">:</span>
        promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          _this<span class="token punctuation">.</span>onFulfilledFn<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          _this<span class="token punctuation">.</span>onRejectedFn<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>_this<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">catch</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">finally</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

MyPromise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 调用官方测试用例，需实现一个promise的延迟对象 defer</span>
MyPromise<span class="token punctuation">.</span>defer <span class="token operator">=</span> MyPromise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dfd <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  dfd<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dfd<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
    dfd<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">promisesAplusTests</span><span class="token punctuation">(</span>MyPromise<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/js/transformation.html" class="prev">数据类型转换的4大核心规则</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9730f399.js" defer></script><script src="/assets/js/2.213b8df9.js" defer></script><script src="/assets/js/5.99232bff.js" defer></script>
  </body>
</html>
